name: Run conftest-unittests.sh

on:
  pull_request:
    branches: [ main ]

jobs:
  docker:
    name: Check docker build
    runs-on: ubuntu-latest
    steps:
      - name: Check out Docker file code in the root directory
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Check if dockerimage build is working
        run: docker build -f ./Dockerfile .

      - name: Build docker images
        run: docker build -t local < .Dockerfile
      - name: Run tests
        run: docker run -it -v $PWD:/srv -w/srv local skopeo inspect docker://quay.io/cvpops/test-index:v4.10
             
  conftest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Conftest
        uses: redhat-cop/github-actions/confbatstest@master
        with:
          tests: tests/conftest-unittests.sh
          policies: '[]' # An empty array is provided as the policies are already cloned via source.
